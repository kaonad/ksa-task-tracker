<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlManar KSA Project - Visual Workflow</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1f1f1f 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
        }

        .progress-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .instructions {
            text-align: center;
            margin-top: 12px;
            font-size: 0.875rem;
            color: #a0aec0;
        }

            .instructions strong {
                color: #e2e8f0;
            }

        .add-task-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .add-task-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 30px rgba(255, 107, 53, 0.6);
            }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        .modal-subtitle {
            font-size: 0.875rem;
            color: #a0aec0;
            margin-top: 4px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

            .close-btn:hover {
                color: #fff;
            }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 0.875rem;
            font-family: 'IBM Plex Sans', sans-serif;
            transition: border-color 0.2s;
        }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                outline: none;
                border-color: #ff6b35;
            }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-select {
            cursor: pointer;
        }

            .form-select option {
                background: #2d2d2d;
                color: #fff;
            }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

            .btn-secondary:hover {
                background: rgba(255, 255, 255, 0.15);
            }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

            .color-option:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            .color-option.selected {
                border-color: #fff;
                box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
            }

        h1 {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #a0aec0;
            font-weight: 300;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

            .timeline::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 2px;
                background: linear-gradient(180deg, #ff6b35 0%, #f7931e 100%);
            }

        .category-section {
            margin-bottom: 60px;
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: both;
        }

            .category-section:nth-child(1) {
                animation-delay: 0.1s;
            }

            .category-section:nth-child(2) {
                animation-delay: 0.2s;
            }

            .category-section:nth-child(3) {
                animation-delay: 0.3s;
            }

            .category-section:nth-child(4) {
                animation-delay: 0.4s;
            }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }

            .category-header:hover {
                transform: translateX(4px);
            }

                .category-header:hover .collapse-icon {
                    transform: scale(1.1);
                }

        .category-dot {
            position: absolute;
            left: -47px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid;
            background: #1a1a1a;
            z-index: 2;
        }

        .design .category-dot {
            border-color: #ff6b35;
        }

        .admin .category-dot {
            border-color: #4ecdc4;
        }

        .legal .category-dot {
            border-color: #f7931e;
        }

        .investor .category-dot {
            border-color: #45b7d1;
        }

        .category-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .collapse-icon {
            margin-left: auto;
            font-size: 1.2rem;
            color: #a0aec0;
            transition: transform 0.3s ease;
            padding: 4px;
        }

        .category-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .task-count {
            font-size: 0.875rem;
            color: #a0aec0;
            margin-left: 8px;
            font-weight: 400;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .design .category-badge {
            background: rgba(255, 107, 53, 0.2);
            color: #ff9d76;
        }

        .admin .category-badge {
            background: rgba(78, 205, 196, 0.2);
            color: #7ee8df;
        }

        .legal .category-badge {
            background: rgba(247, 147, 30, 0.2);
            color: #ffc168;
        }

        .investor .category-badge {
            background: rgba(69, 183, 209, 0.2);
            color: #8dd4e8;
        }

        .tasks-grid {
            display: grid;
            gap: 20px;
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.5s ease, opacity 0.3s ease, margin-top 0.3s ease;
            opacity: 1;
            margin-top: 0;
        }

        .category-section.collapsed .tasks-grid {
            max-height: 0;
            opacity: 0;
            margin-top: -30px;
        }

        .task-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
            border-left: 4px solid;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
        }

            .task-card.completed {
                opacity: 0.6;
                background: rgba(78, 205, 196, 0.1);
                border-left-color: #4ecdc4 !important;
            }

                .task-card.completed .task-description {
                    text-decoration: line-through;
                    opacity: 0.7;
                }

            .task-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .task-card:hover {
                transform: translateX(8px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            }

                .task-card:hover::before {
                    opacity: 1;
                }

        .design .task-card {
            border-left-color: #ff6b35;
        }

        .admin .task-card {
            border-left-color: #4ecdc4;
        }

        .legal .task-card {
            border-left-color: #f7931e;
        }

        .investor .task-card {
            border-left-color: #45b7d1;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .task-id {
            font-family: 'Space Mono', monospace;
            font-size: 0.875rem;
            opacity: 0.6;
            font-weight: 700;
        }

        .task-owner {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .task-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-card.completed .task-status {
            background: #4ecdc4;
            border-color: #4ecdc4;
        }

            .task-card.completed .task-status::after {
                content: '✓';
                color: white;
                font-size: 14px;
                font-weight: bold;
            }

        .task-actions {
            position: absolute;
            top: 12px;
            right: 50px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin: 10px 20px;
        }

        .task-card:hover .task-actions {
            opacity: 1;
        }

        .task-edit-btn,
        .task-delete-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

            .task-edit-btn:hover {
                background: #f7931e;
                transform: scale(1.1);
            }

            .task-delete-btn:hover {
                background: #e74c3c;
                transform: scale(1.1);
            }

        .task-card:hover .task-status {
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.1);
        }

        .task-description {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 16px;
            color: #e2e8f0;
        }

        .task-meta {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.875rem;
            color: #a0aec0;
        }

        .meta-label {
            font-weight: 600;
            opacity: 0.7;
        }

        .dependency-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(237, 100, 166, 0.2);
            border: 1px solid rgba(237, 100, 166, 0.4);
            border-radius: 4px;
            font-size: 0.75rem;
            color: #fbb6ce;
        }

        .deadline {
            color: #fbd38d;
            font-weight: 600;
        }

        .critical-milestone {
            background: rgba(245, 101, 101, 0.1);
            border: 2px dashed #fc8181;
            padding: 24px;
            border-radius: 12px;
            margin-top: 60px;
            text-align: center;
        }

            .critical-milestone h3 {
                font-family: 'Space Mono', monospace;
                font-size: 1.3rem;
                margin-bottom: 12px;
                color: #fc8181;
            }

            .critical-milestone p {
                color: #e2e8f0;
                font-size: 1rem;
            }

        .legend {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 60px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .timeline {
                padding-left: 30px;
            }

            .category-dot {
                left: -37px;
            }

            .task-card {
                padding: 16px;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>AlManar Project Workflow</h1>
            <p class="subtitle">Strategic Development Timeline | End of January 2025</p>
        </header>

        <div class="progress-section">
            <div class="progress-stats">
                <div class="stat-item">
                    <div class="stat-number" id="completedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="remainingCount">13</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="progressPercent">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="instructions">
                <strong>Click any task card</strong> to mark it as completed or uncompleted
            </div>
        </div>

        <div class="timeline">
            <!-- Design & Planning -->
            <div class="category-section design">
                <div class="category-header">
                    <div class="category-dot"></div>
                    <div class="category-title">
                        Design & Planning
                        <span class="category-badge">4 Tasks</span>
                    </div>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="tasks-grid">
                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#1</span>
                            <span class="task-owner">Al Mnaber</span>
                        </div>
                        <div class="task-description">
                            3D sketch showing volumes, location of building on plot and parking spaces
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 20, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Purpose:</span>
                                <span>Visualize elevators, loading bay, reception</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#2</span>
                            <span class="task-owner">SK</span>
                        </div>
                        <div class="task-description">
                            Add units layout to open floor design
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 22, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">Task #1</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#3</span>
                            <span class="task-owner">Al Mnaber</span>
                        </div>
                        <div class="task-description">
                            Complete final preliminary design for end-of-month agreement
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 31, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">Task #2</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#4</span>
                            <span class="task-owner">Istikbal Team</span>
                        </div>
                        <div class="task-description">
                            Review and sign design & permitting contract + initial payment (110K SAR)
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 31, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">Task #3</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Administration -->
            <div class="category-section admin">
                <div class="category-header">
                    <div class="category-dot"></div>
                    <div class="category-title">
                        Administration
                        <span class="category-badge">2 Tasks</span>
                    </div>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="tasks-grid">
                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#5</span>
                            <span class="task-owner">Istikbal Team</span>
                        </div>
                        <div class="task-description">
                            Obtain 2 mobile phone lines in company name (banking & admin)
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 18, 2025</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#6</span>
                            <span class="task-owner">Istikbal Team</span>
                        </div>
                        <div class="task-description">
                            Register mobile lines with Absher, Nafath and ANB
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 20, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">Task #5</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legal & Governance -->
            <div class="category-section legal">
                <div class="category-header">
                    <div class="category-dot"></div>
                    <div class="category-title">
                        Legal & Governance
                        <span class="category-badge">4 Tasks</span>
                    </div>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="tasks-grid">
                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#7</span>
                            <span class="task-owner">Al Ammar Law</span>
                        </div>
                        <div class="task-description">
                            Finalize SHA draft and circulate to core investors for comments
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 25, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Note:</span>
                                <span>Shareholder Agreement</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#8</span>
                            <span class="task-owner">HM + SK + Al Ammar Law</span>
                        </div>
                        <div class="task-description">
                            Finalize Management Agreement and circulate for DocuSign
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 25, 2025</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#9</span>
                            <span class="task-owner">Al Ammar Law</span>
                        </div>
                        <div class="task-description">
                            Convert Istikbal's loan to shares and amend AoA
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 31, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">Miqdadi readiness</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#10</span>
                            <span class="task-owner">Al Ammar Law</span>
                        </div>
                        <div class="task-description">
                            Amend CLA to reflect new shareholding structure
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 31, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">Task #9</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investor Relations -->
            <div class="category-section investor">
                <div class="category-header">
                    <div class="category-dot"></div>
                    <div class="category-title">
                        Investor Relations
                        <span class="category-badge">3 Tasks</span>
                    </div>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="tasks-grid">
                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#11</span>
                            <span class="task-owner">MZ</span>
                        </div>
                        <div class="task-description">
                            Book venue for end-of-month investors meeting
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 25, 2025</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#12</span>
                            <span class="task-owner">HM + SK</span>
                        </div>
                        <div class="task-description">
                            Agree and finalize meeting agenda
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 27, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Focus:</span>
                                <span>LP/strategic investor discussion</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-card">
                        <div class="task-header">
                            <span class="task-id">#13</span>
                            <span class="task-owner">HM + SK</span>
                        </div>
                        <div class="task-description">
                            Prepare all documentation and presentation
                        </div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Deadline:</span>
                                <span class="deadline">Jan 29, 2025</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">Tasks #7, #8, #12</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="critical-milestone">
            <h3>⚡ Critical End-of-Month Milestones</h3>
            <p>Final preliminary design agreed | All legal documentation finalized | Investor meeting completed</p>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b35;"></div>
                <span>Design & Planning</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4ecdc4;"></div>
                <span>Administration</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f7931e;"></div>
                <span>Legal & Governance</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #45b7d1;"></div>
                <span>Investor Relations</span>
            </div>
        </div>
    </div>

    <!-- Add Task Button -->
    <button class="add-task-btn" id="addTaskBtn" title="Add New Task">+</button>

    <!-- Add Task Modal -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="modalTitle">Add New Task</h2>
                    <p class="modal-subtitle" id="modalSubtitle"></p>
                </div>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <form id="addTaskForm" data-edit-mode="false" data-edit-index="">
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-select" id="taskCategory" required>
                        <option value="">Select category...</option>
                        <option value="design">Design & Planning</option>
                        <option value="admin">Administration</option>
                        <option value="legal">Legal & Governance</option>
                        <option value="investor">Investor Relations</option>
                        <option value="new-category">➕ Create New Category</option>
                    </select>
                </div>
                <div class="form-group" id="newCategoryFields" style="display: none;">
                    <label class="form-label">New Category Name *</label>
                    <input type="text" class="form-input" id="newCategoryName" placeholder="e.g., Operations, Finance">
                    <label class="form-label" style="margin-top: 12px;">Category Color</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
                        <div class="color-option" data-color="#ff6b35" style="background: #ff6b35;"></div>
                        <div class="color-option" data-color="#4ecdc4" style="background: #4ecdc4;"></div>
                        <div class="color-option" data-color="#f7931e" style="background: #f7931e;"></div>
                        <div class="color-option" data-color="#45b7d1" style="background: #45b7d1;"></div>
                        <div class="color-option" data-color="#e74c3c" style="background: #e74c3c;"></div>
                        <div class="color-option" data-color="#9b59b6" style="background: #9b59b6;"></div>
                        <div class="color-option" data-color="#27ae60" style="background: #27ae60;"></div>
                        <div class="color-option" data-color="#f39c12" style="background: #f39c12;"></div>
                    </div>
                    <input type="hidden" id="newCategoryColor" value="#ff6b35">
                </div>
                <div class="form-group">
                    <label class="form-label">Task Description *</label>
                    <textarea class="form-textarea" id="taskDescription" required placeholder="Describe the task..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Owner *</label>
                    <input type="text" class="form-input" id="taskOwner" required placeholder="e.g., Al Mnaber, SK, HM + SK">
                </div>
                <div class="form-group">
                    <label class="form-label">Deadline</label>
                    <input type="date" class="form-input" id="taskDeadline">
                </div>
                <div class="form-group">
                    <label class="form-label">Dependencies</label>
                    <input type="text" class="form-input" id="taskDependencies" placeholder="e.g., Task #1, Task #3">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-input" id="taskNotes" placeholder="Additional information...">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDUA1yPBuds9CIPhnimuKrnnFricrb0HNc",
            authDomain: "ksa-task-tracker.firebaseapp.com",
            databaseURL: "https://ksa-task-tracker-default-rtdb.firebaseio.com",
            projectId: "ksa-task-tracker",
            storageBucket: "ksa-task-tracker.firebasestorage.app",
            messagingSenderId: "981201496523",
            appId: "1:981201496523:web:ece1196f931636efdaae4e"
        };

        // Initialize Firebase
        let database;
        let tasksRef;
        let completedTasksRef;
        let customCategoriesRef;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            tasksRef = database.ref('almanar/tasks');
            completedTasksRef = database.ref('almanar/completed');
            customCategoriesRef = database.ref('almanar/categories');
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase not configured. Using local storage mode. See setup instructions.');
        }

        // Load saved progress and custom tasks from Firebase or fallback to localStorage
        const STORAGE_KEY = 'almanar_task_progress';
        const TASKS_KEY = 'almanar_custom_tasks';
        let completedTasks = [];
        let customTasks = [];
        let customCategories = {};

        // Firebase sync functions
        function saveCompletedToFirebase() {
            if (completedTasksRef) {
                completedTasksRef.set(completedTasks).catch(err => {
                    console.error('Error saving to Firebase:', err);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(completedTasks));
                });
            } else {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(completedTasks));
            }
        }

        function saveTasksToFirebase() {
            console.log('Saving tasks to Firebase:', customTasks.length, 'tasks');
            isLocalUpdate = true; // Set flag before saving
            if (tasksRef) {
                tasksRef.set(customTasks).then(() => {
                    console.log('Tasks saved to Firebase successfully');
                    setTimeout(() => { isLocalUpdate = false; }, 500); // Reset after delay
                }).catch(err => {
                    console.error('Error saving tasks to Firebase:', err);
                    isLocalUpdate = false;
                    localStorage.setItem(TASKS_KEY, JSON.stringify(customTasks));
                });
            } else {
                isLocalUpdate = false;
                localStorage.setItem(TASKS_KEY, JSON.stringify(customTasks));
            }
        }

        function saveCategoriesToFirebase() {
            if (customCategoriesRef) {
                customCategoriesRef.set(customCategories).catch(err => {
                    console.error('Error saving categories to Firebase:', err);
                    localStorage.setItem('almanar_custom_categories', JSON.stringify(customCategories));
                });
            } else {
                localStorage.setItem('almanar_custom_categories', JSON.stringify(customCategories));
            }
        }

        // Listen for real-time updates from Firebase
        let isLocalUpdate = false; // Flag to prevent processing our own updates

        function initializeFirebaseListeners() {
            if (completedTasksRef) {
                completedTasksRef.on('value', (snapshot) => {
                    if (isLocalUpdate) {
                        console.log('Ignoring completed tasks update (local change)');
                        return;
                    }
                    const data = snapshot.val();
                    console.log('Firebase: Completed tasks updated', data);
                    if (data) {
                        completedTasks = data;
                        // Re-render UI
                        updateTaskCompletionUI();
                        updateProgress();
                    }
                });
            }

            if (tasksRef) {
                tasksRef.on('value', (snapshot) => {
                    if (isLocalUpdate) {
                        console.log('Ignoring tasks update (local change)');
                        isLocalUpdate = false; // Reset flag
                        return;
                    }
                    const data = snapshot.val();
                    console.log('Firebase: Tasks listener triggered');
                    console.log('Firebase data:', data);
                    console.log('Current customTasks before Firebase update:', customTasks);

                    // CRITICAL: Don't overwrite with empty array or null
                    if (!data || data.length === 0) {
                        console.warn('Firebase returned empty/null, keeping current customTasks');
                        return;
                    }

                    // Only update if different
                    if (JSON.stringify(data) !== JSON.stringify(customTasks)) {
                        console.log('Firebase has different data, updating customTasks');
                        customTasks = data;
                        // Reload custom tasks
                        reloadCustomTasks();
                    } else {
                        console.log('Firebase data same as local, no update needed');
                    }
                });
            }

            if (customCategoriesRef) {
                customCategoriesRef.on('value', (snapshot) => {
                    if (isLocalUpdate) {
                        console.log('Ignoring categories update (local change)');
                        return;
                    }
                    const data = snapshot.val();
                    console.log('Firebase: Categories updated', data);
                    if (data) {
                        customCategories = data;
                        Object.assign(categoryConfig, data);
                        // Apply styles and update dropdown
                        Object.keys(data).forEach(slug => {
                            addCategoryStyles(slug, data[slug].color);
                            updateCategoryDropdown(slug, data[slug].name);
                        });
                    }
                });
            }
        }

        function updateTaskCompletionUI() {
            const taskCards = document.querySelectorAll('.task-card');
            taskCards.forEach((card, index) => {
                const taskId = index + 1;
                if (completedTasks.includes(taskId)) {
                    card.classList.add('completed');
                } else {
                    card.classList.remove('completed');
                }
            });
        }

        function reloadCustomTasks() {
            // Remove existing custom tasks from DOM
            document.querySelectorAll('.task-card').forEach((card, index) => {
                if (index >= 13) { // Original tasks are 0-12
                    card.remove();
                }
            });

            // Reload custom tasks
            loadCustomTasks();
            initializeTasks();
            initializeCollapse();
        }

        function updateCategoryDropdown(slug, name) {
            const dropdown = document.getElementById('taskCategory');
            const existingOption = dropdown.querySelector(`option[value="${slug}"]`);
            if (!existingOption) {
                const newOption = document.createElement('option');
                newOption.value = slug;
                newOption.textContent = name;
                dropdown.insertBefore(newOption, dropdown.lastElementChild);
            }
        }

        // Category configuration
        const categoryConfig = {
            design: {
                name: 'Design & Planning',
                className: 'design',
                color: '#ff6b35'
            },
            admin: {
                name: 'Administration',
                className: 'admin',
                color: '#4ecdc4'
            },
            legal: {
                name: 'Legal & Governance',
                className: 'legal',
                color: '#f7931e'
            },
            investor: {
                name: 'Investor Relations',
                className: 'investor',
                color: '#45b7d1'
            }
        };

        // Load custom categories from Firebase
        function loadCustomCategories() {
            if (customCategoriesRef) {
                customCategoriesRef.once('value').then((snapshot) => {
                    const savedCustomCategories = snapshot.val() || {};
                    if (savedCustomCategories && typeof savedCustomCategories === 'object') {
                        customCategories = savedCustomCategories;
                        Object.assign(categoryConfig, savedCustomCategories);

                        // Apply styles for all custom categories on page load
                        Object.keys(savedCustomCategories).forEach(slug => {
                            if (savedCustomCategories[slug] && savedCustomCategories[slug].color) {
                                addCategoryStyles(slug, savedCustomCategories[slug].color);
                                updateCategoryDropdown(slug, savedCustomCategories[slug].name);
                            }
                        });
                    }
                }).catch(err => {
                    console.error('Error loading custom categories:', err);
                });
            } else {
                // Fallback to localStorage
                try {
                    const savedCustomCategories = JSON.parse(localStorage.getItem('almanar_custom_categories')) || {};
                    if (savedCustomCategories && typeof savedCustomCategories === 'object') {
                        customCategories = savedCustomCategories;
                        Object.assign(categoryConfig, savedCustomCategories);

                        // Apply styles for all custom categories on page load
                        Object.keys(savedCustomCategories).forEach(slug => {
                            if (savedCustomCategories[slug] && savedCustomCategories[slug].color) {
                                addCategoryStyles(slug, savedCustomCategories[slug].color);
                                updateCategoryDropdown(slug, savedCustomCategories[slug].name);
                            }
                        });
                    }
                } catch (err) {
                    console.error('Error loading categories from localStorage:', err);
                }
            }
        }

        // Function to add CSS styles for a category
        function addCategoryStyles(categorySlug, color) {
            // Check if style element exists, if not create it
            let styleEl = document.getElementById('dynamic-category-styles');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamic-category-styles';
                document.head.appendChild(styleEl);
            }

            // Calculate lighter version of color for backgrounds
            const rgbaColor = hexToRgba(color, 0.2);
            const lightColor = lightenColor(color, 30);

            const css = `
                    .${categorySlug} .category-dot { border-color: ${color}; }
                    .${categorySlug} .category-badge { background: ${rgbaColor}; color: ${lightColor}; }
                    .${categorySlug} .task-card { border-left-color: ${color}; }
                `;

            styleEl.textContent += css;
        }

        // Helper function to convert hex to rgba
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Helper function to lighten color
        function lightenColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        // Get all task cards
        let taskCards = document.querySelectorAll('.task-card');

        // Edit and Delete functionality
        window.editTaskByIndex = function (taskIndex) {
            editTask(taskIndex);
        };

        window.deleteTaskByIndex = function (taskIndex) {
            deleteTask(taskIndex);
        };

        function editTask(taskIndex) {
            console.log('=== EDIT TASK CALLED ===');
            console.log('Edit button clicked! Task index:', taskIndex);
            console.log('customTasks array:', customTasks);
            console.log('customTasks.length:', customTasks.length);

            if (customTasks.length === 0) {
                console.error('ERROR: customTasks array is EMPTY!');
                alert('Error: No tasks found in memory. The customTasks array is empty. Please refresh the page.');
                return;
            }

            console.log('Task to edit:', customTasks[taskIndex]);

            const task = customTasks[taskIndex];
            if (!task) {
                console.error('Task not found at index:', taskIndex);
                alert('Error: Task not found. Index: ' + taskIndex + ', Array length: ' + customTasks.length);
                return;
            }

            console.log('Opening edit modal for task:', task);

            // Set form to edit mode
            const form = document.getElementById('addTaskForm');
            form.setAttribute('data-edit-mode', 'true');
            form.setAttribute('data-edit-index', taskIndex);

            // Update modal title
            document.getElementById('modalTitle').textContent = 'Edit Task';
            document.getElementById('modalSubtitle').textContent = `Task #${taskIndex + 14}`;
            document.getElementById('submitBtn').textContent = 'Update Task';

            // Populate form with existing data
            document.getElementById('taskCategory').value = task.category;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskOwner').value = task.owner;
            document.getElementById('taskDeadline').value = task.deadline || '';
            document.getElementById('taskDependencies').value = task.dependencies || '';
            document.getElementById('taskNotes').value = task.notes || '';

            console.log('Modal should be opening now...');

            // Show modal
            modal.classList.add('active');

            console.log('Modal classes:', modal.className);
        }

        function deleteTask(taskIndex) {
            console.log('=== DELETE TASK CALLED ===');
            console.log('taskIndex:', taskIndex);
            console.log('typeof customTasks:', typeof customTasks);
            console.log('Array.isArray(customTasks):', Array.isArray(customTasks));
            console.log('customTasks.length:', customTasks.length);

            // Log each task individually
            for (let i = 0; i < customTasks.length; i++) {
                console.log(`customTasks[${i}]:`, customTasks[i]);
            }

            if (taskIndex < 0 || taskIndex >= customTasks.length) {
                console.error('Invalid task index:', taskIndex, 'Array length:', customTasks.length);
                alert('Error: Invalid task index ' + taskIndex + '. Array has ' + customTasks.length + ' items.');
                return;
            }

            console.log('Deleting task at index', taskIndex, ':', customTasks[taskIndex]);
            console.log('Task description:', customTasks[taskIndex].description);

            // Remove from customTasks array
            const deletedTask = customTasks.splice(taskIndex, 1)[0];

            console.log('Deleted task:', deletedTask);
            console.log('After delete, customTasks.length:', customTasks.length);

            // Save to Firebase
            saveTasksToFirebase();

            // CRITICAL: Reload ALL custom tasks to fix indices
            // Remove all custom task cards from DOM
            console.log('Removing all custom task cards from DOM...');
            const allTaskCards = document.querySelectorAll('.task-card');
            let removedCount = 0;
            allTaskCards.forEach((card, index) => {
                if (index >= 13) { // Only remove custom tasks
                    card.remove();
                    removedCount++;
                }
            });
            console.log('Removed', removedCount, 'custom task cards');

            // Reload all custom tasks with correct indices
            console.log('Reloading', customTasks.length, 'tasks...');
            for (let i = 0; i < customTasks.length; i++) {
                console.log('Adding task', i, ':', customTasks[i]);
                addTaskToDOM(customTasks[i], i + 14);
            }

            // Reinitialize
            console.log('Reinitializing...');
            initializeTasks();
            initializeCollapse();
            updateProgress();
            console.log('=== DELETE COMPLETE ===');
        }

        function addEditDeleteButtons(taskCard, taskIndex) {
            // Only add to custom tasks (index 13+)
            if (taskIndex < 13) return;

            const customTaskIndex = taskIndex - 13;

            // Check if buttons already exist
            if (taskCard.querySelector('.task-actions')) return;

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'task-actions';
            actionsDiv.innerHTML = `
                    <button class="task-edit-btn" title="Edit task">✎</button>
                    <button class="task-delete-btn" title="Delete task">🗑</button>
                `;

            taskCard.appendChild(actionsDiv);

            // Add event listeners
            const editBtn = actionsDiv.querySelector('.task-edit-btn');
            const deleteBtn = actionsDiv.querySelector('.task-delete-btn');

            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                editTask(customTaskIndex);
            });

            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTask(customTaskIndex);
            });
        }

        // Initialize tasks
        function initializeTasks() {
            taskCards = document.querySelectorAll('.task-card');

            // Add status indicator and data-task-id to each card
            taskCards.forEach((card, index) => {
                const taskId = index + 1;
                card.setAttribute('data-task-id', taskId);

                // Add status indicator if not already present
                if (!card.querySelector('.task-status')) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'task-status';
                    card.insertBefore(statusDiv, card.firstChild);
                }

                // Add edit/delete buttons for custom tasks
                addEditDeleteButtons(card, index);

                // Restore completed state if saved
                if (completedTasks.includes(taskId)) {
                    card.classList.add('completed');
                }

                // Add click handler
                card.addEventListener('click', function (e) {
                    // Don't toggle if clicking edit/delete buttons
                    if (e.target.closest('.task-actions')) return;
                    toggleTask(taskId, card);
                });
            });

            updateProgress();
        }

        function toggleTask(taskId, card) {
            card.classList.toggle('completed');

            if (card.classList.contains('completed')) {
                // Add to completed tasks
                if (!completedTasks.includes(taskId)) {
                    completedTasks.push(taskId);
                }
            } else {
                // Remove from completed tasks
                completedTasks = completedTasks.filter(id => id !== taskId);
            }

            // Save to Firebase
            saveCompletedToFirebase();

            // Update progress display
            updateProgress();
        }

        function updateProgress() {
            const totalTasks = taskCards.length;
            const completed = completedTasks.length;
            const remaining = totalTasks - completed;
            const percent = Math.round((completed / totalTasks) * 100);

            document.getElementById('completedCount').textContent = completed;
            document.getElementById('remainingCount').textContent = remaining;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // Collapse/Expand functionality
        function initializeCollapse() {
            const categoryHeaders = document.querySelectorAll('.category-header');

            categoryHeaders.forEach(header => {
                header.addEventListener('click', function (e) {
                    // Don't trigger if clicking on a task card
                    if (e.target.closest('.task-card')) return;

                    const categorySection = this.closest('.category-section');
                    categorySection.classList.toggle('collapsed');
                });
            });
        }

        // Modal functionality
        const modal = document.getElementById('addTaskModal');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const addTaskForm = document.getElementById('addTaskForm');
        const taskCategorySelect = document.getElementById('taskCategory');
        const newCategoryFields = document.getElementById('newCategoryFields');
        const colorOptions = document.querySelectorAll('.color-option');

        // Show/hide new category fields
        taskCategorySelect.addEventListener('change', function () {
            if (this.value === 'new-category') {
                newCategoryFields.style.display = 'block';
            } else {
                newCategoryFields.style.display = 'none';
            }
        });

        // Color picker functionality
        colorOptions.forEach(option => {
            option.addEventListener('click', function () {
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                document.getElementById('newCategoryColor').value = this.dataset.color;
            });
        });

        // Select first color by default
        if (colorOptions.length > 0) {
            colorOptions[0].classList.add('selected');
        }

        addTaskBtn.addEventListener('click', () => {
            // Reset to add mode
            const form = document.getElementById('addTaskForm');
            form.setAttribute('data-edit-mode', 'false');
            form.setAttribute('data-edit-index', '');
            document.getElementById('modalTitle').textContent = 'Add New Task';
            document.getElementById('modalSubtitle').textContent = '';
            document.getElementById('submitBtn').textContent = 'Add Task';

            modal.classList.add('active');
        });

        closeModal.addEventListener('click', () => {
            modal.classList.remove('active');
            addTaskForm.reset();
        });

        cancelBtn.addEventListener('click', () => {
            modal.classList.remove('active');
            addTaskForm.reset();
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
                addTaskForm.reset();
            }
        });

        // Add/Edit task
        addTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const form = e.target;
            const isEditMode = form.getAttribute('data-edit-mode') === 'true';
            const editIndex = parseInt(form.getAttribute('data-edit-index'));

            let category = document.getElementById('taskCategory').value;
            const description = document.getElementById('taskDescription').value;
            const owner = document.getElementById('taskOwner').value;
            const deadline = document.getElementById('taskDeadline').value;
            const dependencies = document.getElementById('taskDependencies').value;
            const notes = document.getElementById('taskNotes').value;

            // Handle new category creation
            if (category === 'new-category') {
                const newCategoryName = document.getElementById('newCategoryName').value.trim();
                const newCategoryColor = document.getElementById('newCategoryColor').value;

                if (!newCategoryName) {
                    alert('Please enter a category name');
                    return;
                }

                // Create slug from name (lowercase, no spaces)
                const categorySlug = newCategoryName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

                // Add to category config
                categoryConfig[categorySlug] = {
                    name: newCategoryName,
                    className: categorySlug,
                    color: newCategoryColor
                };

                // Save custom categories to Firebase
                customCategories[categorySlug] = categoryConfig[categorySlug];
                saveCategoriesToFirebase();

                // Add to dropdown for future use
                const newOption = document.createElement('option');
                newOption.value = categorySlug;
                newOption.textContent = newCategoryName;
                taskCategorySelect.insertBefore(newOption, taskCategorySelect.lastElementChild);

                // Add CSS styles for the new category
                addCategoryStyles(categorySlug, newCategoryColor);

                category = categorySlug;
            }

            const taskData = {
                category,
                description,
                owner,
                deadline,
                dependencies,
                notes,
                timestamp: isEditMode ? customTasks[editIndex].timestamp : Date.now()
            };

            if (isEditMode) {
                // Update existing task
                customTasks[editIndex] = taskData;

                // Save to Firebase
                saveTasksToFirebase();

                // Reload all custom tasks to ensure indices are correct
                const allTaskCards = document.querySelectorAll('.task-card');
                allTaskCards.forEach((card, index) => {
                    if (index >= 13) { // Only remove custom tasks
                        card.remove();
                    }
                });

                // Reload all custom tasks with correct indices
                customTasks.forEach((task, index) => {
                    addTaskToDOM(task, index + 14);
                });

                // Reinitialize
                initializeTasks();
                initializeCollapse();
            } else {
                // Add new task
                console.log('=== ADDING NEW TASK ===');
                console.log('typeof customTasks:', typeof customTasks);
                console.log('Array.isArray(customTasks):', Array.isArray(customTasks));
                console.log('customTasks.length before:', customTasks.length);
                console.log('taskData to add:', taskData);

                customTasks.push(taskData);

                console.log('customTasks.length after push:', customTasks.length);
                console.log('Direct access to last item:', customTasks[customTasks.length - 1]);

                // Log each item
                for (let i = 0; i < customTasks.length; i++) {
                    console.log(`customTasks[${i}]:`, customTasks[i]);
                }

                // Save to Firebase (this will NOT trigger reload because of isLocalUpdate flag)
                saveTasksToFirebase();

                // Add to DOM manually (since Firebase won't trigger reload)
                const newTaskId = customTasks.length + 13;
                console.log('Adding task to DOM with ID:', newTaskId);
                addTaskToDOM(taskData, newTaskId);

                // Reinitialize tasks and collapse
                initializeTasks();
                initializeCollapse();
                console.log('=== TASK ADDITION COMPLETE ===');
                console.log('Final customTasks.length:', customTasks.length);
            }

            // Close modal and reset form
            modal.classList.remove('active');
            addTaskForm.reset();
            newCategoryFields.style.display = 'none';
            form.setAttribute('data-edit-mode', 'false');
            form.setAttribute('data-edit-index', '');
        });

        function addTaskToDOM(task, taskId) {
            const config = categoryConfig[task.category];

            // Find the category section
            let categorySection = document.querySelector(`.category-section.${config.className}`);

            // If category section doesn't exist, create it
            if (!categorySection) {
                categorySection = createCategorySection(config);
                document.querySelector('.timeline').appendChild(categorySection);
            }

            const tasksGrid = categorySection.querySelector('.tasks-grid');

            // Format deadline
            let deadlineText = 'No deadline';
            if (task.deadline) {
                const date = new Date(task.deadline);
                deadlineText = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }

            // Calculate custom task index (for edit/delete)
            const customTaskIndex = taskId - 14;

            // Create task card HTML
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            taskCard.setAttribute('data-task-id', taskId);
            taskCard.setAttribute('data-custom-index', customTaskIndex);
            taskCard.innerHTML = `
                    <div class="task-status"></div>
                    <div class="task-actions">
                        <button class="task-edit-btn" onclick="event.stopPropagation(); window.editTaskByIndex(${customTaskIndex});" title="Edit task">✎</button>
                        <button class="task-delete-btn" onclick="event.stopPropagation(); window.deleteTaskByIndex(${customTaskIndex});" title="Delete task">🗑</button>
                    </div>
                    <div class="task-header">
                        <span class="task-id">#${taskId}</span>
                        <span class="task-owner">${task.owner}</span>
                    </div>
                    <div class="task-description">
                        ${task.description}
                    </div>
                    <div class="task-meta">
                        <div class="meta-item">
                            <span class="meta-label">Deadline:</span>
                            <span class="deadline">${deadlineText}</span>
                        </div>
                        ${task.dependencies ? `
                            <div class="meta-item">
                                <span class="meta-label">Depends on:</span>
                                <span class="dependency-badge">${task.dependencies}</span>
                            </div>
                        ` : ''}
                        ${task.notes ? `
                            <div class="meta-item">
                                <span class="meta-label">Note:</span>
                                <span>${task.notes}</span>
                            </div>
                        ` : ''}
                    </div>
                `;

            tasksGrid.appendChild(taskCard);

            // Add click handler for task completion
            taskCard.addEventListener('click', function (e) {
                // Don't toggle if clicking edit/delete buttons
                if (e.target.closest('.task-actions')) return;
                if (e.target.closest('button')) return;
                toggleTask(taskId, taskCard);
            });
        }

        function createCategorySection(config) {
            const section = document.createElement('div');
            section.className = `category-section ${config.className}`;
            section.innerHTML = `
                    <div class="category-header">
                        <div class="category-dot"></div>
                        <div class="category-title">
                            ${config.name}
                            <span class="category-badge">Custom</span>
                        </div>
                        <span class="collapse-icon">▼</span>
                    </div>
                    <div class="tasks-grid"></div>
                `;
            return section;
        }

        // Load custom tasks on page load
        function loadCustomTasks() {
            console.log('loadCustomTasks called');
            if (tasksRef) {
                tasksRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    console.log('Firebase loaded tasks:', data);
                    if (data) {
                        customTasks = data;
                        console.log('Set customTasks from Firebase, length:', customTasks.length);
                        customTasks.forEach((task, index) => {
                            console.log('Loading task', index, ':', task.description);
                            addTaskToDOM(task, index + 14);
                        });
                    } else {
                        console.log('No tasks in Firebase yet');
                    }
                }).catch(err => {
                    console.error('Error loading from Firebase:', err);
                    // Fallback to localStorage
                    customTasks = JSON.parse(localStorage.getItem(TASKS_KEY)) || [];
                    console.log('Loaded from localStorage, length:', customTasks.length);
                    customTasks.forEach((task, index) => {
                        addTaskToDOM(task, index + 14);
                    });
                });
            } else {
                // Fallback to localStorage
                customTasks = JSON.parse(localStorage.getItem(TASKS_KEY)) || [];
                console.log('No Firebase, loaded from localStorage, length:', customTasks.length);
                customTasks.forEach((task, index) => {
                    addTaskToDOM(task, index + 14);
                });
            }
        }

        // Load completed tasks on page load
        function loadCompletedTasks() {
            if (completedTasksRef) {
                completedTasksRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        completedTasks = data;
                        updateTaskCompletionUI();
                        updateProgress();
                    }
                });
            } else {
                // Fallback to localStorage
                completedTasks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            }
        }

        // Initialize on page load
        loadCustomCategories();
        loadCustomTasks();
        loadCompletedTasks();
        initializeTasks();
        initializeCollapse();

        // Start Firebase real-time listeners
        if (database) {
            initializeFirebaseListeners();
        }

        // Add reset functionality (optional - hidden shortcut)
        document.addEventListener('keydown', function (e) {
            // Press Ctrl+Shift+R to reset all progress
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                if (confirm('Reset all task progress?')) {
                    completedTasks = [];
                    if (completedTasksRef) {
                        completedTasksRef.set([]);
                    } else {
                        localStorage.removeItem(STORAGE_KEY);
                    }
                    taskCards.forEach(card => card.classList.remove('completed'));
                    updateProgress();
                }
            }
            // Press Ctrl+Shift+D to delete all custom tasks
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                if (confirm('Delete all custom tasks?')) {
                    customTasks = [];
                    if (tasksRef) {
                        tasksRef.set([]);
                    } else {
                        localStorage.removeItem(TASKS_KEY);
                    }
                    location.reload();
                }
            }
        });
    </script>
</body>
</html>
